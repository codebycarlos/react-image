{"version":3,"file":"index.js","sources":["../jsSrc/useImage.js","../jsSrc/imagePromiseFactory.js","../jsSrc/Img.js"],"sourcesContent":["import { useState } from 'react';\nimport imagePromiseFactory from './imagePromiseFactory';\nconst removeBlankArrayElements = (a) => a.filter((x) => x);\nconst stringToArray = (x) => (Array.isArray(x) ? x : [x]);\nconst cache = {};\n// sequential map.find for promises\nconst promiseFind = (arr, promiseFactory) => {\n    let done = false;\n    return new Promise((resolve, reject) => {\n        const queueNext = (src) => {\n            return promiseFactory(src).then(() => {\n                done = true;\n                resolve(src);\n            });\n        };\n        arr\n            .reduce((p, src) => {\n            // ensure we aren't done before enquing the next source\n            return p.catch(() => {\n                if (!done)\n                    return queueNext(src);\n            });\n        }, queueNext(arr.shift()))\n            .catch(reject);\n    });\n};\nexport default function useImage({ srcList, imgPromise = imagePromiseFactory({ decode: true }), useSuspense = true, }) {\n    const [, setIsLoading] = useState(true);\n    const sourceList = removeBlankArrayElements(stringToArray(srcList));\n    const sourceKey = sourceList.join('');\n    if (!cache[sourceKey]) {\n        // create promise to loop through sources and try to load one\n        cache[sourceKey] = {\n            promise: promiseFind(sourceList, imgPromise),\n            cache: 'pending',\n            error: null,\n        };\n    }\n    // when promise resolves/reject, update cache & state\n    cache[sourceKey].promise\n        // if a source was found, update cache\n        // when not using suspense, update state to force a rerender\n        .then((src) => {\n        cache[sourceKey] = { ...cache[sourceKey], cache: 'resolved', src };\n        if (!useSuspense)\n            setIsLoading(false);\n    })\n        // if no source was found, or if another error occured, update cache\n        // when not using suspense, update state to force a rerender\n        .catch((error) => {\n        cache[sourceKey] = { ...cache[sourceKey], cache: 'rejected', error };\n        if (!useSuspense)\n            setIsLoading(false);\n    });\n    if (cache[sourceKey].cache === 'resolved') {\n        return { src: cache[sourceKey].src, isLoading: false, error: null };\n    }\n    if (cache[sourceKey].cache === 'rejected') {\n        if (useSuspense)\n            throw cache[sourceKey].error;\n        return { isLoading: false, error: cache[sourceKey].error, src: undefined };\n    }\n    // cache[sourceKey].cache === 'pending')\n    if (useSuspense)\n        throw cache[sourceKey].promise;\n    return { isLoading: true, src: undefined, error: null };\n}\n//# sourceMappingURL=useImage.js.map","// returns a Promisized version of Image() api\nexport default ({ decode = true, crossOrigin = '' }) => (src) => {\n    return new Promise((resolve, reject) => {\n        const i = new Image();\n        if (crossOrigin)\n            i.crossOrigin = crossOrigin;\n        i.onload = () => {\n            decode && i.decode ? i.decode().then(resolve).catch(reject) : resolve();\n        };\n        i.onerror = reject;\n        i.src = src;\n    });\n};\n//# sourceMappingURL=imagePromiseFactory.js.map","import React from 'react';\nimport useImage from './useImage';\nimport imagePromiseFactory from './imagePromiseFactory';\nconst passthroughContainer = (x) => x;\nexport default function Img({ decode = true, src: srcList = [], loader = null, unloader = null, container = passthroughContainer, loaderContainer = passthroughContainer, unloaderContainer = passthroughContainer, imgPromise, useSuspense = false, ...imgProps // anything else will be passed to the <img> element\n }) {\n    const { crossorigin, crossOrigin } = imgProps ?? {};\n    const crossOriginToUse = (() => {\n        if (crossorigin !== undefined && crossOrigin !== undefined) {\n            const imgPropsKeys = Object.keys(imgProps);\n            const crossoriginIndex = imgPropsKeys.findIndex((x) => x === 'crossorigin');\n            const crossOriginIndex = imgPropsKeys.findIndex((x) => x === 'crossOrigin');\n            return crossOriginIndex > crossoriginIndex ? crossOrigin : crossorigin;\n        }\n        return crossOrigin ?? crossorigin;\n    })();\n    imgPromise =\n        imgPromise || imagePromiseFactory({ decode, crossOrigin: crossOriginToUse });\n    const { src, isLoading } = useImage({\n        srcList,\n        imgPromise,\n        useSuspense,\n    });\n    // console.log({src, isLoading, resolvedSrc, useSuspense})\n    // show img if loaded\n    if (src)\n        return container(React.createElement(\"img\", { src: src, ...imgProps }));\n    // show loader if we have one and were still trying to load image\n    if (!useSuspense && isLoading)\n        return loaderContainer(loader);\n    // show unloader if we have one and we have no more work to do\n    if (!useSuspense && unloader)\n        return unloaderContainer(unloader);\n    return null;\n}\n//# sourceMappingURL=Img.js.map"],"names":["useImage","_ref","srcList","_ref$imgPromise","imgPromise","imagePromiseFactory","decode","_ref$useSuspense","useSuspense","useState","setIsLoading","_useState","sourceList","removeBlankArrayElements","stringToArray","sourceKey","join","cache","promise","promiseFind","error","then","src","isLoading","_ref$decode","_ref$crossOrigin","crossOrigin","Promise","resolve","reject","i","Image","onload","onerror","a","filter","x","Array","isArray","arr","promiseFactory","done","queueNext","reduce","p","shift","passthroughContainer","_ref$src","_ref$loader","loader","_ref$unloader","unloader","_ref$container","container","_ref$loaderContainer","loaderContainer","_ref$unloaderContaine","unloaderContainer","imgProps","_objectWithoutPropertiesLoose","_excluded","_ref2","crossorigin","crossOriginToUse","imgPropsKeys","Object","keys","crossoriginIndex","findIndex","crossOriginIndex","_useImage","React"],"mappings":"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"}